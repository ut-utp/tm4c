[target.'cfg(all(target_arch = "arm", target_os = "none"))']
runner = "gdb -q -x .gdbconfig"
# runner = "cargo run --manifest-path .cargo/xtask/Cargo.toml"


rustflags = [
  "-C", "link-arg=-Tlink.x",
#  "-C", "linker=flip-link", # TODO
  "-C", "force-frame-pointers=yes",
]


# Really what we want is `default-target` (an unstable Cargo feature:
# https://doc.rust-lang.org/cargo/reference/unstable.html#per-package-target)
# so that we can have the `xtask` package be built for the host and the
# `utp-tm4c` package built for ARM.
#
# But, it doesn't look like the feature above is headed towards stabilization
# anytime soon and we don't want to tie ourselves to nightly so we stick with
# this and stomach needing to be in the repo root to `cargo run`/`cargo flash`.
[build]
target = "thumbv7em-none-eabihf" # Cortex-M4F and Cortex-M7F (with FPU)

[alias]

# Normally `xtask`s live in the same workspace as the actual repositories but
# TODO (target difference; need `default-target` or `forced-target` both of which require nightly which we don't want to necessiate)
# other option is to encode the embedded target purely in the xtask or in aliases but this is undesirable because it breaks extensions (i.e. cargo bloat)
#
# the downside to this option is that it requires you to be in the root of the repo because of the relative path here.
xtask = "-q run --manifest-path .cargo/xtask/Cargo.toml --"

b = "build --release"
r = "run --release"
f = "xtask flash --release"

debug = "r"
flash = "f"

# Notes:
# call stack: cargo +nightly call-stack  --bin utp-tm4c | dot -Tpng > out.png
# cargo +nightly -Z build-std=core run
# (^ with force-frame-pointers=yes)
# cargo +nightly stack-sizes --bin utp-tm4c --release
